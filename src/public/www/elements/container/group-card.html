<dom-module id='group-card'>
  <template>
    <style>
      :host {
        border-radius: 6px;
        -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;
        -webkit-touch-callout: none; -webkit-tap-highlight-color:rgba(0,0,0,0);
        /*padding: 0.4em;*/
        font-family: Fira Sans Light;
        font-weight: normal;
        /*z-index: auto;*/
      }
      section#main {
        background: #f1f1f1;
        border: none;
        border-color: #AAA;
        border-radius: inherit;
        box-shadow: 0 4px 5px 0 rgba(0, 0, 0, 0.14),
                    0 1px 10px 0 rgba(0, 0, 0, 0.12),
                    0 2px 4px -1px rgba(0, 0, 0, 0.4);
      }
      section#main[dark] {
        background: #959595;
        border-color: #444;
      }
      section#main[name='*'], section#main[nowindow] {
        background: transparent;
        border-radius: inherit;
        box-shadow: none;
        border-color: transparent;
      }
      section#header {
        display: flex;
        position: relative;
        border-top-left-radius: inherit;
        border-top-right-radius: inherit;
        overflow: hidden;
        border-bottom-left-radius: 0px;
        border-bottom-right-radius: 0px;
        background: var(--bright-primary-color);
        color: var(--bright-text-color);
        font-size: 1em;
        transition: max-height linear 180ms, min-height linear 180ms;
        min-height: 2.6em;
      }
      section#header[dark] {
        background: var(--dark-primary-color);
        color: var(--highlight-color);
      }
      section#header[opened] {
        min-height: calc(15vh + 120px);
        max-height: 40vh;
      }
      section#title {
        cursor: pointer;
        position: relative;
        bottom: 0;
        left: 0;
        height: 100%;
        width: 100%;
        font-size: 1.1em;
        padding: 0.6em 0.8em;
        box-sizing: border-box;
        color: white;
        border-top-left-radius: inherit;
        border-top-right-radius: inherit;
        border-bottom-left-radius: 0px;
        border-bottom-right-radius: 0px;
        background: linear-gradient(to top, rgba(255,255,255,0.05) 10%,rgba(255,255,255,0.15) 60%);
        text-transform: none;
      }
      section#header section#title.over-image {
        position: absolute;
        height: auto;
        width: auto;
        bottom: 0;
        left: 0;
        background: none !important;
        text-shadow: -1px 0px 1px #1f1f1f;
      }
      section#title[dark] {
        color: var(--highlight-color);
      }
      section#mainContent {
        flex-direction: row;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: flex-start;
        border-top-width: thin;
        border-top-style: solid;
        border-top-color: inherit;
        border-top-left-radius: 0px;
        border-top-right-radius: 0px;
        border-bottom-left-radius: inherit;
        border-bottom-right-radius: inherit;
        padding: 0.5em 0em 0em 0.5em;
        background: none;
        box-sizing: border-box;
        height: auto;
        width: auto;
        overflow: visible;
      }
      section#mainContent[dark] {
        background: none;
      }
      @media all and (min-width: 750px) and (max-width: 1280px) and (orientation: portrait) {
        section#main:not([name='*']) {
          max-width: 31.5em;
        }
      }
      @media all and (min-width: 600px) and (max-width: 1280px) and (orientation: landscape) {
        section#main:not([name='*']) {
          max-width: 31.5em;
        }
      }
      @media all and (min-width: 1280px) {
        section#main:not([name='*']) {
          max-width: 39.5em;
        }
      }
      section#mainContent ::content > * {
        margin: 0 0.5em 0.5em 0;
        border-radius: 12px;
      }

      section#header ::content .header {
        display: flex;
        flex: 1;
        position: relative;
      }
      section#header svg-element {
        display: flex;
        flex: 1;
        position: relative;
      }

    </style>
    <section id='main' name$='[[title]]' nowindow$='[[withoutWindow]]'>

      <section id='header' hidden$='[[_hideTitle(title,withoutWindow)]]'>
        <content select='.header'></content>
        <svg-element id='svgElement' hidden$='[[!svg.source]]' source="[[svg.source]]" exceeding-elements='{{exceedingElements}}' initially-zoom-to-selected max-zoom='5' min-zoom='1.2' opened="[[opened]]"></svg-element>
        <section id='title' on-tap='toggle'>[[title]]</section>
      </section>

      <section id='mainContent'>
        <content></content>
      </section>
    </section>

  </template>
  <script>
    GroupCard = Polymer({
      is: 'group-card',

      behaviors: [
        ContainerBehavior,
        Polymer.IronResizableBehavior
      ],

      properties: {
        title: {
          type: String,
          value: '',
          observer: '_titleChanged',
          reflectToAttribute: true
        },
        placeholder: {
          type: String,
          value: ''
        },
        withoutWindow: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
        },
        opened: {
          type: Boolean,
          value: false
        },
        svg: {
          type: Object
        }
      },

      factoryImpl: function(title, svg, dark, withoutWindow) {
        this.set('title', title || '');
        if (dark) {
          this.$.mainContent.setAttribute('dark', true);
          this.$.header.setAttribute('dark', true);
          this.$.main.setAttribute('dark', true);
          this.$.title.setAttribute('dark', true);
        }
        if (withoutWindow)
          this.setAttribute('withoutWindow', true);
      },

      observers: [
        '_selectedChanged(selectedElements.splices)',
        '_exceedingChanged(exceedingElements.splices)'
      ],

      toggle: function() {
        if (!this.opened) {
          this.open();
        }
        else {
          this.close();
        }
      },

      open: function() {
        var headerContainers = this.queryAllEffectiveChildren('.header[container]');

        if (headerContainers.length === 0 && (this.svg === undefined || this.svg.source === undefined))
          return;

        this.$.title.classList.add('over-image');
        this.$.header.setAttribute('opened', true);

        headerContainers.forEach( function(c) {
          c.opened = true;
        }, this);

        this.opened = true;
      },

      close: function() {
        this.$.title.classList.remove('over-image');
        this.$.header.removeAttribute('opened');

        var headerContainers = this.queryAllEffectiveChildren('.header[container]');
        headerContainers.forEach( function(c) {
          c.opened = false;
        }, this);

        this.opened = false;
      },

      _titleChanged: function(text) {
        if (!text || text === 'undefined')
          this.set('title', this.placeholder);
        this.$.header.setAttribute('aria-label', this.title);
      },

      _hideTitle: function(title,withoutWindow) {
        if(title === '*' || withoutWindow)
          return true;
        else
          return false;
      },

      _selectedChanged: function(e) {
        this.close();
      },

      _exceedingChanged: function(changeRecord) {
        if (changeRecord && changeRecord.indexSplices) {
          var headerElements = this.queryAllEffectiveChildren('.header[element]');
          var headerContainers = this.queryAllEffectiveChildren('.header[container]');
          for (var i=0; i < changeRecord.indexSplices.length; i++) {
            changeRecord.indexSplices[i].removed.forEach( function(item) {
              headerElements.forEach( function(el) {
                el.unsetElement(item);
              }, this);
              headerContainers.forEach( function(c) {
                c.unsetExceedingElement(item);
              }, this);
            })
            var index, item;
            for (var j = 0; j < changeRecord.indexSplices[i].addedCount; j++) {
              index = changeRecord.indexSplices[i].index + j;
              item = changeRecord.indexSplices[i].object[index];
              headerElements.forEach( function(el) {
                el.setElement(item);
              }, this);
              headerContainers.forEach( function(c) {
                c.setExceedingElement(item);
              }, this);
            }
            headerContainers.forEach( function(c) {
              c.opened = true;
            }, this);
            this.open();
          }
        }
      }
    });
  </script>
</dom-module>
