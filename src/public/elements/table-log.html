<script src="../bower_components/webcomponentsjs/webcomponents.min.js"></script>
<script src="../bower_components/jquery/dist/jquery.min.js"></script>
<script src='../js/underscore/underscore.js'></script>

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">

<polymer-element name="table-log" attributes="turned collapsed">

  <template>

    <style>
      [unresolved] {
        opacity: 0;
      }

      :host {
        color: #1d1d1d;
        overlay: hidden;
        z-index: 0;
        outline: none;
        font-size: 1em;
        width: 100%;
        user-select: none;
      }

      .selector {
        background: white;
      }

      paper-icon-button::shadow #ripple {
        color: #f1f1f1;
      }

      paper-tabs {
        color: #f1f1f1;
        background: #669db4;
        text-transform: uppercase;
        font-family: 'Roboto-Regular';
        font-size: 0.9em;
        border-radius: 5px;
        font-weight: 150;
      }

      paper-tabs::shadow #selectionBar {
        background-color: #f1f1f1;
        height: 3px;
        border-radius: 5px;
      }

      paper-tab::shadow #ink {
        color: #f1f1f1;
        }

      paper-tabs /deep/ paper-icon-button {
        color: #f1f1f1;
      }

      paper-tabs /deep/ paper-tab {
        border-radius: 5px;
      }

      paper-tabs /deep/ paper-tab :hover {
        background: rgba(255, 255, 255, 0.50);
      }

      th, td {
        padding: 6px 5px 4px;
        font-size: 0.9em;
        font-weight: 300;
      }

      .grouptitle {
        padding: 1.5em 1em 0em;
        font-size: 0.7em;
        background: white;
        font-style: oblique;
        font-weight: 700;
      }

    </style>

    <section vertical layout>
      <section id="tabs" relative>
        <paper-tabs id="tableselect" selected="{{selected}}" scrollable>
          <paper-tab>Alle</paper-tab>
          <paper-tab>Datum</paper-tab>
          <paper-tab>Raum</paper-tab>
          <paper-tab>Typ</paper-tab>
          <paper-tab>Wert</paper-tab>
        </paper-tabs>
      </section>

      <section id="main">

      </section>
    </section>
  </template>


  <script>

    Polymer('table-log',{

      ready: function() {
        // connect to the data from data-processor, when it is loaded
        $(document).on('dataLoaded', function(event, data) {
            var arr = _.sortBy(data.content,'date').reverse();
            arr = _.sortBy(arr,'var');
            arr = _.sortBy(arr,'kind');
            arr = _.sortBy(arr,'room');
            $('table-log').attr('data', JSON.stringify(arr));
        });
      },

      publish: {
        tab: [],
        data: [],
        selected: 1
      },

      dataChanged: function() {
        this.$.main.innerHTML = groupedTable(this.data,this.selected);
      },

      selectedChanged: function() {
        this.$.main.innerHTML = groupedTable(this.data,this.selected);
      },

      domReady: function() {
      }
    });

      // Menu Items and titles of a head of table
    title = {
        "all": "Alle", /*spezielles Attribut f√ºr dieses Element*/
        "date": "Datum",
        "room": "Raum",
        "kind": "Typ",
        "var": "Methode",
        "value": "Wert"
    };

      // grouping the table
    function groupedTable(arr,sel) {

      if (sel === 0) {
        var htmlcode = "<table class='striped hoverable centered'>" + theadCreate() +
          tbodyCreate(arr) + "</table>";
      }
      else {
        var groupTitle = _.keys(title)[sel];
        var groupedData = _.groupBy(arr,groupTitle);

        var keys = _.keys(groupedData);
        var vals = _.values(groupedData);

        var htmlcode = "";

        var a = "active";
        for (var i=0; i<keys.length; i++) {
          htmlcode += '<section class="grouptitle">' + keys[i] + '</section>' + '<hr>' +
            '<section><table class="striped hoverable centered">' + theadCreate(groupTitle) +
            tbodyCreate(vals[i],groupTitle) + '</table></section>';
          a = "";
        }
      }
      return htmlcode;
    }

      // create head of a table
    function theadCreate(ex) {
      var tabletitle = title;
      tabletitle = _.values(_.omit(tabletitle,ex,'all'));

      htmlcode = "<thead>";

      for (var i=0; i<tabletitle.length; i++) {
        htmlcode += "<th on-click='{{sort}}'>"+tabletitle[i]+"</th>";
      }

      htmlcode += "</thead>";
      return htmlcode;
    }

      //create body of a table
    function tbodyCreate(arr,ex) {
      var line = [];
      htmlcode = "<tbody>";

      for (var i=0; i<arr.length; i++) {
        line = _.omit(arr[i],ex);
        htmlcode += "<tr>";

        if (line.date) {htmlcode += "<td>" + line.date + "</td>";}
        if (line.room) {htmlcode += "<td>" + line.room + "</td>";}
        if (line.kind) {htmlcode += "<td>" + line.kind + "</td>";}
        if (line.var) {htmlcode += "<td>" + line.var + "</td>";}
        if (line.value) {htmlcode += "<td style='background:" + line.color + ";'>" + line.value + " " + line.unit + "</td>";}

        htmlcode += "</tr>";
      }

      htmlcode += "</tbody>";
      return htmlcode;
    }

  </script>

</polymer-element>
