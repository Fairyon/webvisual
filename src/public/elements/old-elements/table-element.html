<polymer-element name="table-element" attributes="">

  <template>
    <style>
      .value#false {
        background: linear-gradient(180deg, rgba({{colorLow}}, 0.75), rgba({{colorLow}}, 0.5), rgba({{colorLow}}, 0.75));
      }
      .value#true {
        background: linear-gradient(180deg, rgba({{colorHigh}}, 0.75), rgba({{colorHigh}}, 0.5), rgba({{colorHigh}}, 0.75));
      }
      tr#false:hover {
        background: rgba({{colorLow}}, 0.15);
      }
      tr#true:hover {
        background: rgba({{colorHigh}}, 0.15);
      }
      tr:hover {
        background: rgba({{linecolor}}, 0.1);
      }
      .core-selected {
        background-color: rgba({{linecolor}}, 0.2);
      }
      div.groupTitle {
        border-bottom: thin solid rgba({{linecolor}}, 0.15);
      }
      tr, th {
        border-bottom: thin solid rgba({{linecolor}}, 0.10);
      }
      #toggleIcon {
        color: rgba({{linecolor}}, 0.5);
      }
    </style>

    <link rel="stylesheet" type='text/css' href="../css/elements/table-element.css" />

    <section vertical layout>
      <section>
        <paper-tabs id="tabs" valueattr="name" self-end selected="{{groupBy}}">
          <paper-tab name="all">{{titleForAll}}</paper-tab>
          <template repeat="{{key, i in keys}}">
            <paper-tab name="{{key}}" >{{titles[i]}}</paper-tab>
          </template>
        </paper-tabs>
      </section>

      <core-selector id="selector" target="{{$.main}}" itemsSelector="div.groupTitle" selected="-1">
        <section id="main" relative>

          <template if="{{groupBy !== 'all'}}">
            <template repeat="{{groups, i in data}}">
              <div class="groupTitle" horizontal layout>
                <paper-item class="groupTitle" flex>{{groupTitles[i]}}</paper-item>
                <core-icon-button id="toggleIcon" icon="{{i == $.selector.selected && i != previousActive ? openedIcon : closedIcon}}" on-tap="{{tapItem}}"></core-icon-button>
              </div>
              <core-collapse class="groupCollapse" duration="1" opened?="{{i == $.selector.selected && i != previousActive}}">
                <table>
                  <template repeat="{{key, i in keys}}">
                    <template if="{{key != groupBy}}">
                      <th on-click="{{sort}}" class="tableTitle" id="{{key}}">
                        <paper-item class='tableHead'>{{titles[i]}}<template if="{{sortSelected == key}}"><section id="toggleIcon" flex>{{sortedRow[key] ? sortUp : sortDown}}</section></template>
                        </paper-item>
                      </th>
                    </template>
                  </template>

                  <template repeat="{{groups as group}}">
                    <tr class="row" id="{{group['exceeds']}}">
                      <template repeat="{{keys as key}}">
                        <template if="{{key != groupBy}}">
                          <td class="{{key}}" id="{{group['exceeds']}}">{{group[key]}} {{key == 'value' ? group['unit'] : ''}}</td>
                        </template>
                      </template>
                    </tr>
                  </template>
                </table>
              </core-collapse>
            </template>
          </template>

          <template if="{{groupBy === 'all'}}">
            <table>
              <template repeat="{{key, i in keys}}">
                <th on-click="{{sort}}" class="tableTitle" id="{{key}}">
                  <paper-item class='tableHead'>{{titles[i]}}<template if="{{sortSelected == key}}"><section id="toggleIcon" flex>{{sortedRow[key] ? sortUp : sortDown}}</section></template>
                  </paper-item>
                </th>
              </template>

              <template repeat="{{data as group}}">
                <tr class="row" id="{{group['exceeds']}}">
                  <template repeat="{{keys as key}}">
                    <td class="{{key}}" id="{{group['exceeds']}}">{{group[key]}} {{key == 'value' ? group['unit'] : ''}}</td>
                  </template>
                </tr>
              </template>
            </table>
          </template>
        </section>
      </core-selector>
    </section>
  </template>

  <script>
    Polymer('table-element',{
      ready: function() {
      },

      publish: {
        receive: [],
        reduced: [],
        data: [],
        groupTitles: [],
        keys: ["date", "room", "kind", "var", "value"],
        titles: ["Datum", "Raum", "Typ", "Eigenschaft", "Wert"],
        titleForAll: "Alle",
        sortedRow: {
          "date": true,
          "room": false,
          "kind": false,
          "var": false,
          "value": false
        },
        sortSelected: "",
        groupBy: "all",
        previousActive: -1,
        closedIcon: 'expand-more',
        openedIcon: 'expand-less',
        sortUp: "▴",
        sortDown: "▾",
        colorLow: "55, 20, 255",
        colorHigh: "255, 21, 41",
        linecolor: "100, 100, 100"
      },

      receiveChanged: function() {
        // incoming data changed
        this.reduceData();
        this.groupByChanged();
      },

      reduceData: function() {
        tmp = [];
        for (i=0; i<this.receive.length; i++) {
          for (j=0; j<this.receive[i].data.length; j++) {
            tmp.push({"id":    this.receive[i].id,
                      "room":  this.receive[i].room,
                      "kind":  this.receive[i].kind,
                      "var" :  this.receive[i].var,
                      "unit":  this.receive[i].unit,
                      "date":  this.receive[i].data[j].date,
                      "value": this.receive[i].data[j].value,
                      "exceeds": this.receive[i].data[j].exceeds,
                      "color":  this.receive[i].data[j].color});
          }
        }
        this.reduced = tmp;
      },

      tapItem: function(){
        // if an item was selected again, the previous page is -1, so that it
        // can collapse back
        this.previousActive = (this.$.selector.selected == this.previousActive) ? -1 : this.$.selector.selected;
      },

      groupByChanged: function(){
        // this is ineffective and must be replaced by a call request to a
        //  database, which delivers grouped and/or sorted data, and operates
        // on the server
        if (this.groupBy != "all") {
          var tmp = _.groupBy(this.reduced,this.groupBy);
          this.groupTitles = _.keys(tmp);
          tmp = _.values(tmp);
          // initialize the inner-selector - does not work, if initialy 'all' is
          // selected
          this.$.selector.selected = -1;
          this.previousActive = -1;
          this.data = tmp;
        }
        else {
          this.data = this.reduced;
        }
        // initialize sort-selection
        this.sortSelected = "";
      },

      sort: function(e, detail, sender) {
        this.sortingSelected(sender.getAttribute('id'));
      },

      sortingSelected: function(sel) {
        // sorting should be happening in the database, what is needed
        if (sel) {
          // finding the direction
          var direction;

          if (this.sortSelected == sel) {
            this.sortedRow[sel] = !this.sortedRow[sel];
            direction = (this.sortedRow[sel]) ? 1 : -1;
          }
          else {
            this.sortSelected = sel;
            this.sortedRow[sel] = true;
            direction = 1;
          }
          var tmp;
          if (this.groupBy == 'all'){
            tmp = this.data;
            tmp = tmp.sort(
              function(left, right) {
                if (left[sel] > right[sel]) return 1*direction;
                if (left[sel] < right[sel]) return -1*direction;
                if (left[sel] == right[sel]) {
                  if (left.date > right.date) return -1;
                  if (left.date < right.date) return 1;
                  return 0;
                }
            });
          }
          else {
            for (i=0; i<this.data.length; i++) {
              tmp = this.data;
              tmp[i] = tmp[i].sort(
                function(left, right) {
                  if (left[sel] > right[sel]) return 1*direction;
                  if (left[sel] < right[sel]) return -1*direction;
                  if (left[sel] == right[sel]) {
                    if (left.date > right.date) return -1;
                    if (left.date < right.date) return 1;
                    return 0;
                  }
              });
            }
          }
          this.data = tmp;
        }
      }
    });
  </script>

</polymer-element>
