<!-- Using d3.js-library -->

<dom-module id='chart-element'>

<style>
  :host {
    font-family: inherit;
    font-size: 0.65em;
    letter-spacing: normal !important;
    border-radius: inherit;
    -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;
    -webkit-touch-callout: none; -webkit-tap-highlight-color:rgba(0,0,0,0);
    flex: 1;
    display: flex;
    width: auto;
    height: auto;
  	overflow: hidden;
    visibility: visible;
    -webkit-touch-callout: none !important;
      -webkit-user-select: none !important;
       -khtml-user-select: none !important;
         -moz-user-select: none !important;
          -ms-user-select: none !important;
              user-select: none !important;
  }
  svg#svg {
    flex: 1;
    /*min-height: 25vh;*/
    /*height: auto;*/
  }
  rect.plot {
      fill: rgba(248, 252, 255, 0.9) !important;
  }
  g.grid .tick {
      stroke: rgba(31, 31, 31, 0.2);
  }
  g.grid path {
      stroke-width: 0;
  }
  g.axis path, g.axis line {
      fill: none;
      stroke: rgba(31, 31, 31, 0.2);
      shape-rendering: crispEdges;
      stroke-width: 1.5px;
  }
  /*g.x.axis path {
      display: none !important;
  }*/
  line.focus.line {
      fill: none;
      stroke: rgba(39, 116, 217, 0.5);
      stroke-width: 3px;
  }
  g#context .brush .extent {
    stroke: #fff;
    fill-opacity: .125;
    shape-rendering: crispEdges;
  }

</style>

<template>
  <svg id='svg' version='1.1' xmlns='http://www.w3.org/2000/svg'>
    <g id='chart'>
      <rect class='plot'></rect>
      <g class='x axis'></g>
      <g class='y axis'></g>
      <g class='x grid'></g>
      <g class='y grid'></g>
      <clippath id='clip'>
        <rect x='0' y='0'></rect>
      </clippath>
      <g id='focus'>
        <line class='focus line' y1=0></line>
      </g>
    </g>
    <g id='context'>
    </g>
  </svg>
  <content id='collector' select='graph-element'></content>
</template>

  <script>
    ChartElement = Polymer({
      is: 'chart-element',

      properties: {
        margin: {
          type: Object,
          value: function() {
            return {  top: 20,
                      right: 20,
                      bottom: 100,
                      left: 45  };
          }
        },
        width: {
          type: Number,
          value: 0
        },
        height: {
          type: Number,
          value: 0
        },
        ticks: {
          type: Number,
          value: 6
        },
        _width: {
          type: Number,
          value: 0
        },
        _height: {
          type: Number,
          value: 0,
        },

        _chart: {},
        _d3Zoom: {},
        _x: {},
        _y: {},
        _x2: {},
        _y2: {},

        _xAxis: {},
        _xAxis2: {},
        _yAxis: {},
        _focus: {},
        _clip: {},
        _context: {},
      },

      get _self () {
        return this;
      },

      get _graphs () {
        return this.getEffectiveChildren();
      },

      _createXAxis: function() {
        return d3.svg.axis()
                 .scale(this._x)
                 .orient('bottom')
                 .ticks(this.ticks)
                 .tickFormat(this.timeFormat);
      },

      _createYAxis: function() {
        return d3.svg.axis()
                 .scale(this._y)
                 .orient('left')
                 .ticks(this.ticks)
                 .tickFormat(this.numberFormat);
      },

      _buildLayout: function() {
        this._chart = d3.select(this.$.chart)
                        .attr('transform', 'translate(' + this.margin.left + ',' + this.margin.top + ')')
                        .on('mouseenter', this._showFocus.bind(this))
                        .on('mousemove', this._drawFocus.bind(this))
                        .on('mouseleave', this._hideFocus.bind(this));
                        // .call(this._d3Zoom);

        this._chart.select('rect.plot')
                  .attr('width', this._width)
                  .attr('height', this._height);

        this._chart.select('g.x.axis')
                  .attr('transform', 'translate(0,' + this._height + ')')
                  .call(this._xAxis);

        this._chart.select('g.y.axis')
                  .call(this._yAxis);

        this._chart.select('g.x.grid')
                  .attr('transform', 'translate(0,' + this._height + ')')
                  .call(this._createXAxis()
                            .tickSize(-this._height, 0, 0)
                            .tickFormat(''));
        this._chart.select('g.y.grid')
                  .call(this._createYAxis()
                            .tickSize(-this._width, 0, 0)
                            .tickFormat(''));
        // Limiting Projection to Margin
        this._clip = this._chart.select('clippath#clip rect')
                                .attr('width', this._width)
                                .attr('height', this._height);

        this._focus = this._chart.select('line.focus.line')
                                 .attr('clip-path', 'url(#clip)')
                                 .attr('y2', this._height);

        this._context = d3.select(this.$.context)
                          .attr("transform", "translate(" + this.margin.left + "," + this._height + ")");

        this._context.append("g")
                     .attr("class", "x axis")
                     .attr("transform", "translate(0," + this._height2 + ")")
                     .call(this._xAxis2);

        this._context.append("g")
                     .attr("class", "x brush")
                     .call(this._brush)
                     .on("contextmenu", this._brush.clear())
                   .selectAll("rect")
                     .attr("y", -6)
                     .attr("height", this._height2 + 7);

        this._chart.selectAll('g.tick,g.tick line,g.tick text,g path.domain')
                   .classed('style-scope', true)
                   .classed('chart-element', true);
        this._context.selectAll('g.tick,g.tick line,g.tick text,g path.domain,.brush,rect,g.axis')
                     .classed('style-scope', true)
                     .classed('chart-element', true);
      },

      created: function() {
        this.locale = d3.locale({
          'decimal': ',',
          'thousands': '_',
          'grouping': [5],
          'currency': ['€', ''],
          'dateTime': '%a %b %e %X %Y',
          'date': '%d.%m.%Y',
          'time': '%H:%M:%S',
          'periods': ['', ''],
          'days': ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'],
          'shortDays': ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'],
          'months': ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'],
          'shortMonths': ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Dez']
        });

        this.timeFormat = this.locale.timeFormat.multi([
        	['.%L', function(d) { return d.getMilliseconds(); }],
        	[':%S', function(d) { return d.getSeconds(); }],
        	['%M', function(d) { return d.getMinutes(); }],
        	['%_H:%M', function(d) { return d.getHours(); }],
        	['%a %d', function(d) { return d.getDay() && d.getDate() != 1; }],
        	['%b %d', function(d) { return d.getDate() != 1; }],
        	['%B', function(d) { return d.getMonth(); }],
        	['%Y', function() { return true; }]
        ]);

        this.numberFormat = this.locale.numberFormat();
      },

      attached: function() {
        var clientRect = this.getBoundingClientRect();
        if (!this.height) {
          this.height = Math.max(clientRect.height, 200);
        }
        if (!this.width) {
          this.width = Math.max(clientRect.width, 300);
        }
        this._width = this.width - this.margin.left - this.margin.right;
        this._height = this.height - this.margin.top - this.margin.bottom;
        this._height2 = this.margin.bottom;

        this._x = d3.time.scale().range([0, this._width]);
        this._y = d3.scale.linear().range([this._height, 0]);

        this._x2 = d3.time.scale().range([0, this._width]),
        this._y2 = d3.scale.linear().range([this._height2, 0]);

        this._xAxis2 = d3.svg.axis().scale(this._x2).orient("bottom");

        d3.select(this.$.svg).attr('viewBox', '0 0 ' + this.width + ' ' + this.height)
                             .attr('preserveAspectRatio', 'xMinYMin meet')
                             .attr('height', null)
                             .attr('width', null);

        this._brush = d3.svg.brush()
                        .x(this._x2)
                        .on("brush", this._brushed.bind(this._self));
      //  var self = this;
      //  this._d3Zoom = d3.behavior.zoom()
      //                            .x(this._x)
      //                            .y(this._y)
      //                            .on('zoom', this._zoom.bind(this));

        this._xAxis = this._createXAxis();
        this._yAxis = this._createYAxis();

        this._buildLayout();
      },

      redraw: function () {
        this.debounce('redraw', function() { this._redraw() },100);
      },

      _redraw: function () {
        this._chart.select('.x.axis').transition(100).call(this._xAxis);
        this._chart.select('.y.axis').transition(100).call(this._yAxis);
        this._chart.select('.x.grid').transition(100)
                   .call(this._createXAxis()
                             .tickSize(-this._height, 0, 0)
                             .tickFormat(''));
        this._chart.select('.y.grid').transition(100)
                   .call(this._createYAxis()
                             .tickSize(-this._width, 0, 0)
                             .tickFormat(''));
        this._brush.extent(this._brush.extent());
        this._context.select('.x.axis').transition(100).call(this._xAxis2);
        this._context.select(".x.brush").transition(100).call(this._brush)
        this._chart.selectAll('g.tick,g.tick line,g.tick text,g path.domain')
                   .classed('style-scope', true)
                   .classed('chart-element', true);
        this._graphs.forEach(function(g) { g.redraw(); });
      },

      _brushed: function() {
        // console.log(this._brush.empty(),this._brush.extent());
        this._x.domain(this._brush.empty() ? this._x2.domain() : this._brush.extent());
        // focus.select(".area").attr("d", area);
        this._chart.select(".x.axis").call(this._xAxis);
      },
      _zoom: function () {
        this._redraw();
        var graphs = Polymer.dom(this.$.collector).querySelectorAll('graph-element');
        graphs.forEach(function(graph) {graph.redraw()});
      },

      _showFocus: function() {
        d3.select('g#focus').style('opacity', 1);
      },
      _drawFocus: function () {
        this._focus.attr('transform', 'translate(' + [d3.event.x - this.margin.left,0] + ')');
      },
      _hideFocus: function() {
        d3.select('g#focus').transition(2000).style('opacity', 0);
      }
    });

  </script>

</dom-module>
