<!-- Dependent to be content of diagram-container -->
<!-- Using d3.js-library -->

<link rel="import" href="../behaviors/element-behavior.html">
<dom-module id="graph-element">

  <script>

    DiagramGraph = Polymer({
      is: 'graph-element',

      behaviors: [ElementBehavior],

      properties: {
        values: {
          type: Array,
          value: function() {
            return [{
                "x": new Date(Math.random()*10 + 1 + Date.now()),
                    "y": Math.random()*10 + 1
            }, {
                "x": new Date(Math.random()*10 + (Math.random()+1)*500 + Date.now()),
                    "y": Math.random()*10 + 1
            }, {
                "x": new Date(Math.random()*10 + (Math.random()+1)*1000 + Date.now()),
                    "y": Math.random()*10 + 1
            }, {
                "x": new Date(Math.random()*10 + (Math.random()+1)*2000 + Date.now()),
                    "y": Math.random()*10 + 1
            }, {
                "x": new Date(Math.random()*10 + (Math.random()+1)*4000 + Date.now()),
                    "y": Math.random()*10 + 1
            }, {
                "x": new Date(Math.random()*10 + (Math.random()+1)*8000 + Date.now()),
                    "y": Math.random()*10 + 1
            }, {
                "x": new Date(Math.random()*10 + (Math.random()+1)*16000 + Date.now()),
                    "y": Math.random()*10 + 1
            }, {
                "x": new Date(Math.random()*10 + (Math.random()+1)*32000 + Date.now()),
                    "y": Math.random()*10 + 1
            }, {
                "x": new Date(Math.random()*10 + (Math.random()+1)*64000 + Date.now()),
                    "y": Math.random()*10 + 1
            }, {
                "x": new Date(Math.random()*10 + (Math.random()+1)*128000 + Date.now()),
                    "y": Math.random()*10 + 1
            }, {
                "x": new Date(Math.random()*100 + (Math.random()+1)*256000 + Date.now()),
                    "y": Math.random()*10 + 1
            }]
          }
        },
        color: {
          type: String,
          value: ""
        },
        dots: {
          type: Boolean,
          value: true
        },
        line: {
          type: Boolean,
          value: true
        },
        dotRadius: {
          type: Number,
          value: 2.5
        },
        lineWidth: {
          type: Number,
          value: 1.5
        }
      },

      _line: {},
      _dots: {},
      _chart: {},
      _node: {},

      factoryImpl: function(element, bubbles) {
        this.setElement(element);
        if (bubbles === true)
          this.bubbles = true;
      },

      attached: function() {
        if (this.parentNode.nodeName !== 'CHART-ELEMENT') {
          console.warn(this.id, "Graph is not attached to a container");
          return;
        }

        // if color is not set, set a Random Color
        if (!this.color) {
          this.color = '#';
          var perm = ["2C", "F5"];
          perm.push(Math.floor(Math.random()*256).toString(16));
          for (var i = 3; i > 0; i--) {
            var pos = Math.floor(Math.random()*i);
            this.color += ((perm[pos].length === 1) ? "0" : "") + perm[pos];
            perm.splice(pos, 1);
          }
        }

        this._chart = this.parentNode._chart;

        this._node = this._chart.append("g")
                                .attr("clip-path", "url(#clip)")
                                .attr("id", this.id)
                                .attr("label", this.label);

        if (this.line)
          this._attachLine();

        if (this.dots)
          this._attachDots();

      },

      _attachLine: function() {
        var self = this;
        this._line = d3.svg.line()
                           .x( function (d) {
                             return self.parentElement._x(d.x);
                           })
                           .y( function (d) {
                             return self.parentElement._y(d.y);
                           });

        this._node.append("svg:path")
                  .datum(this.values)
                  .attr("class", "line")
                  .attr("d", this._line)
                  .attr("fill", "none")
                  .attr("stroke", this.color)
                  .attr("stroke-width", this.lineWidth)
                  .append("title")
                  .text(function(d, i) {
                      return (new Date(d.x)).toLocaleString() + " " + d.y;
                   });
      },

      _attachDots: function() {
        var self = this;
        this._node.selectAll('.dot')
                  .data(this.values).enter()
                  .append("svg:circle")
                  .attr("class", "dot")
                  .attr("cx", function(d,i) {
                    return self.parentElement._x(d.x)})
                  .attr("cy", function(d,i) {
                    return self.parentElement._y(d.y)})
                  .attr("r", this.dotRadius)
                  .attr("fill", "#FFF")
                  .attr("stroke", this.color)
                  .attr("stroke-width", this.lineWidth)
                  .on("click",
                    function() {
                      self._chart.selectAll(".clicked")
                                 .classed("clicked", false)
                                 .attr("fill", "#FFF");
                      this.classList.add("clicked");
                      this.setAttribute("fill", self.color);
                    })
                  .append("title")
                  .text(function(d, i) {
                      return (new Date(d.x)).toLocaleString() + " " + d.y;
                   });
        this._dots = this._node.selectAll('.dot');
      },

      redraw: function() {
        var self = this;
        this._dots.attr("cx", function(d,i) {return self.parentElement._x(d.x)})
                  .attr("cy", function(d,i) {return self.parentElement._y(d.y)})
                  .attr("r", this.dotRadius);
        this._node.select(".line")
                  .attr("class", "line")
                  .attr("d", this._line);
      },

      _updateView: function(value, splices) {
      },

      setValues: function(values) {
      }
    });

  </script>

</dom-module>
