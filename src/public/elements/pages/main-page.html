<dom-module id="main-page">
  <link rel="import" href="../style/main-page.css" type="css"/>
  <style>
    :host {
      font-family: Fira Sans Light;
      font-kerning: normal !important;
      font-style: normal;
      font-size: 1em;
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
      left: 0;
      top: 0;
      position: absolute;
    }
    iron-selector#panelSelector {
      flex: 1;
    }
    iron-selector#panelSelector ::content section.panel {
      position: absolute;
      left: 0;
      overflow-y: auto;
      overflow-x: hidden;
      box-sizing: border-box;
      background: linear-gradient(rgba(255, 255, 255, 0),rgba(255,255,255,0.15));
      color: currentColor;
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      align-content: flex-start;
      -webkit-overflow-scrolling: touch;
      -ms-flex: 1 1 0.000000001px; -webkit-flex: 1; flex: 1;
      flex-basis: 0.000000001px; -webkit-flex-basis: 0.000000001px;
      padding: 0.5em;
      height: 100%;
      width: 100%;
      opacity: 1;
      transition: opacity 500ms ease, transform 750ms ease;
      z-index: 50;
    }
    iron-selector#panelSelector ::content section.panel:not(.iron-selected):not([animated]){
      display: none;
      z-index: 25;
    }
    iron-selector#panelSelector ::content section.panel:not(.iron-selected)[animated]{
      opacity: 0;
      transform: translateY(25%);
      pointer-events: none;
      z-index: 51;
    }
    iron-selector#groupingKeysLabelSelector {
      display: flex;
      flex-direction: column;
    }
    iron-selector#groupingKeysLabelSelector ::content iron-selector.groupingKeySelector {
      display: flex;
      flex-direction: column;
    }
    iron-selector#groupingKeysLabelSelector ::content iron-selector.groupingKeySelector:not(.iron-selected){
      display: none;
    }
    iron-selector#groupingKeysLabelSelector ::content paper-radio-button{
      display: inline-block;
      font-family: Fira Sans Light;
      padding: 0.25em 0.5em;
      font-size: 0.85em;
    }
    section#labelsTabs {
      margin-left: 44px;
      height: 62%;
      align-self: flex-end;
      flex: 2;
      font-family: Fira Sans Light;
      font-size: 16px;
    }
    section#labelsTabs ::content paper-tab.label.iron-selected {
      /*border: thin solid #A8CCDB;*/
      border-bottom: thin solid transparent;
      background: linear-gradient(to top, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0.15));
      color: #f1f1f1;
    }
    section#labelsTabs ::content paper-tab.label:not(.iron-selected){
      /*border: thin solid transparent;*/
    }
    section#labelsTabs ::content paper-tab.label:hover:not(.iron-selected){
      background: linear-gradient(to top, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.04));
    }
    section#labelsTabs ::content paper-tab.label.iron-selected[dark]{
      /*border: thin solid #A8CCDB;*/
      border-bottom: thin solid transparent;
      background: linear-gradient(to top, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.08));
      color: #A8CCDB;
    }
    @media all and (max-width: 600px) {
      :host {
        font-size: 0.9em;
      }
    }
    @media all and (min-width: 1000px) and (max-width: 1200px) {
      :host {
        font-size: 1.1em;
      }
    }
    @media all and (min-width: 1201px) and (max-width: 1400px) {
      :host {
        font-size: 1.15em;
      }
    }
    @media all and (min-width: 1401px)  and (max-width: 1800px){
      :host {
        font-size: 1.2em;
      }
    }
    @media all and (min-width: 1801px) {
      :host {
        font-size: 1.25em;
      }
    }
    @media all and (max-width: 520px) {
      section.panel {
        display: block;
        padding: 0em;
      }
      group-card {
        padding: 0em;
        border-radius: 0em;
        width: 100%;
      }
      section#toolbarHeader paper-icon-button.menu-icon {
        margin-right: 12px;
        margin-left: 12px;
      }
      section#toolbarHeader div.logo-element-placeholder {
        min-width: 44px !important;
        flex: 0;
      }
      logo-element#logo {
        width: 44px !important;
        left: 64px !important;
      }
      section#labelsTabs {
        margin-left: 18px !important;
      }
    }
    @media all and (min-width: 521px) and (max-width: 600px){
      section#toolbarHeader paper-icon-button.menu-icon {
        margin-right: 16px;
        margin-left: 16px;
      }
      logo-element#logo {
        left: 72px !important;
      }
      section#toolbarHeader section#labelsTabs {
        margin-left: 28px !important;
      }
    }
    @media all and (max-width: 600px) {
      section#toolbarHeader paper-icon-button.expand-icon {
        display: none !important;
      }
      section#toolbarFooter[opened] {
        max-height: 32vh;
      }
      :host {
        font-size: 0.9em;
      }
    }
    @media all and (max-height: 690px) {
      section#toolbarHeader paper-icon-button.expand-icon {
        display: none !important;
      }
      section#toolbarFooter[opened] {
        max-height: 32vh;
      }
    }
    @media all and (min-width: 601px) {
      section#toolbarFooter[dark] .caption {
        border-top: none;
      }
      section#toolbarFooter .caption {
        border-top: none;
      }
    }
  </style>

  <template>
    <logo-element id="logo" on-tap="backToMainMenu"></logo-element>
    <!-- TOOLBAR -->
    <section id="toolbar">
      <section id="toolbarHeader">
        <paper-icon-button icon="menu" class="menu-icon" on-tap="toggleDrawer"></paper-icon-button>

        <div class="logo-element-placeholder"></div>

        <section id="labelsTabs">
          <iron-selector id="labelSelector" selected="{{selectedLabelIndex}}" fallback-selection="0">
            <content select="paper-tab.label"></content>
          </iron-selector>
        </section>

        <section id="control">
          <paper-icon-button icon="error-outline" class="error control" on-tap="toggleExceedsPanel" hidden$="[[!isExceeding]]"></paper-icon-button>
          <section hidden$="[[!opened]]" style="display: flex;">
            <paper-icon-button icon="[[_computeExpandIcon(expanded)]]" class="expand-icon" on-tap="_toolbarExpand"></paper-icon-button>
            <paper-icon-button icon="remove" class="toggle-icon control" on-tap="deselectElement"></paper-icon-button>
          </section>
        </section>
      </section>
      <section id="toolbarFooter" opened$="[[opened]]" expanded$="[[expanded]]">
        <section id="toolbarSelectedElement">
          <sign-element id="selectedElementSign" class="selectedElement" horizontal="[[!expanded]]" on-tap="deselectElement"></sign-element>
          <section style="display: flex;">
            <table-element id="selectedElementTable" class="selectedElement"></table-element>
          </section>
          <svg-element id="selectedElementSVG" class="selectedElement"  opened="[[opened]]"
          zoom-partition="1.1" max-zoom="5" min-zoom="1">
          </svg-element>
        </section>
      </section>
    </section>

    <section id="mainView">
      <!-- MAIN VIEW -->
      <section id="mainPanel">

        <!-- Content -->
        <section id="mainContent">
          <iron-selector id="panelSelector" activate-event="" fallback-selection="0">
            <content select="section.panel"></content>
          </iron-selector>
        </section>

        <section id="backdrop" on-tap="tapBackdrop"></section>
        <section id="dropShadow" class="has-shadow"></section>
      </section>

      <!-- EXCEEDING -->
      <section id="exceedsPanel">
        <section id="exceedsHeader" on-tap="toggleExceedsPanel">
          <paper-ripple id="ripple"></paper-ripple>
          <section class="title">Alarme</section>
        </section>
        <iron-swipeable-container id="exceedingElements" on-iron-swipe="_removeSingleExceedingElementFromList"></iron-swipeable-container>
        <span style="padding: 0em 0.75em 0.75em 0.75em; float: right;"><a href="#" on-click="_removeAllExceedingElementFromList">Liste leeren</a></span>
      </section>

      <!-- SIDEMENU -->
      <section id="drawerPanel">
        <paper-button collapse-id="settings" class="sidemenu collapsable" on-tap="toggleCollapse">
          <iron-icon icon="settings"></iron-icon>
          <span class="flex">Einstellungen</span>
          <iron-icon icon="arrow-drop-up" class="collapse-arrow right-icon" id="settings"></iron-icon>
        </paper-button>

          <iron-collapse class="sidemenu collapse settings" opened>
            <section class="indention collapse-content">
              <paper-button collapse-id="grouping" class="sidemenu" on-tap="toggleCollapse">
                <iron-icon icon="reorder"></iron-icon>
                <span class="flex">Gruppierung</span>
                <iron-icon icon="arrow-drop-down" class="collapse-arrow right-icon" id="grouping"></iron-icon>
              </paper-button>

                <iron-collapse class="sidemenu collapse grouping">
                  <section id="groupingKeysButtons" class="indention">
                    <iron-selector id="groupingKeysLabelSelector" activate-event="" fallback-selection="0">
                      <content select="iron-selector.groupingKeySelector"></content>
                    </iron-selector>
                  </section>
                </iron-collapse>

              <paper-item>
                <iron-icon icon="date-range"></iron-icon>
                <paper-toggle-button id="colorschema" on-change="toggleDateView">Zeit anzeigen</paper-toggle-button>
              </paper-item>

              <paper-item>
                <iron-icon icon="editor:border-style"></iron-icon>
                <paper-toggle-button id="border-style" on-change="toggleWindowStyle" checked="{{withoutWindow}}">Fensterstil</paper-toggle-button>
              </paper-item>

              <paper-item>
                <iron-icon icon="settings-brightness"></iron-icon>
                <paper-toggle-button id="colorschema" on-change="toggleTheme">Farbschema</paper-toggle-button>
              </paper-item>

            </section>
          </iron-collapse>

        <paper-button class="sidemenu" on-tap="backToMainMenu">
          <iron-icon icon="arrow-back"></iron-icon>
          <span class="flex">Auswahl</span>
        </paper-button>

      </section>
    </section>

    <section id="svgFullscreenContainer">
      <svg-element id="fullscreenSvg" zoom-partition="2" max-zoom="2.75" min-zoom="0.75" fullscreen initially-zoom-to-selected></svg-element>
    </section>

  </template>
  <script>
    var ExceedingSvgPaths = {};
    Polymer({
      is: 'main-page',

      behaviors: [Polymer.NeonAnimationRunnerBehavior, Polymer.NeonSharedElementAnimatableBehavior],

      properties: {
        sharedElements: {
          value: function() {
            return {
              'herologo2': this.$.logo
            }
          }
        },
        animationConfig: {
          value: function() {
            return {
              'entry': [
                {
                  name: 'hero-animation',
                  id: 'herologo2',
                  toPage: this,
                },
                {
                  name: 'fade-in-animation',
                  node: this.$.mainView
                }
              ],
              'exit': [
                {
                  name: 'scale-down-animation',
                  node: this
                }
              ],
              'select-in': [
                {
                  name: 'cascaded-animation',
                  animation: 'fade-in-animation',
                  timing: {duration: 250},
                  nodeDelay: 50,
                  nodes: [this.$.selectedElementSign, this.$.selectedElementTable, this.$.selectedElementSVG]
                }
              ],
              'select-out': [
                {
                  name: 'cascaded-animation',
                  animation: 'fade-out-animation',
                  timing: {duration: 250},
                  nodeDelay: 50,
                  nodes: [this.$.selectedElementSVG, this.$.selectedElementTable, this.$.selectedElementSign]
                }
              ]
            }
          }
        },
        withoutWindow: {
          type: Boolean,
          value: false
        },
        dark: {
          type: Boolean,
          value: false
        },
        maxTotalLines: {
          type: Number,
          value: 100
        },
        // Attribute for toolbar is opened
        opened: {
          type: Boolean,
          value: false
        },
        expanded: {
          type: Boolean,
          value: false
        },
        showDate: {
          type: Boolean,
          value: false
        },
        selectedElement: {
          type: Object,
          value: function() { return {}; }
        },
        selectedLabelIndex: {
          type: String,
          value: "0"
        },
        isExceeding: {
          type: Boolean,
          notify: true,
          observer: "_checkExceedsPanel"
        },
        animated: {
          type: Boolean,
          value: true,
          reflectToAttribute: true
        }
      },

      attached: function() {
        var self = this;
        Polymer.dom(this.$.groupingKeysLabelSelector)
               .observeNodes(function(info) {
                 for (var i in info.addedNodes)
                  if (info.addedNodes[i].nodeName === "IRON-SELECTOR")
                    info.addedNodes[i].addEventListener("iron-select", function(e){
                      self._regroup(e.currentTarget.selected);
                    });
                  self.$.groupingKeysLabelSelector.select(self.selectedLabelIndex);
               });
        Polymer.dom(this.$.panelSelector)
               .observeNodes( function(info) {
                 if (info.addedNodes.length > 0)
                   self.$.panelSelector.select(self.selectedLabelIndex);
               });
      },

      listeners: {
        "element-select": "setSelectedElement",
        "element-is-exceeding": "_setExceedingElement",
        "element-is-not-exceeding": "_unsetExceedingElement",
        "svg-open-fullscreen": "openSvgFullscreen",
        "svg-exit-fullscreen": "exitSvgFullscreen",
        "labelSelector.iron-select": "_selectedLabelIndexChanged"
      },

      // app Control
      backToMainMenu: function() {
        this.closeDrawer();
        this.fire("restart");
      },
      // Tab Control
      _selectedLabelIndexChanged: function(e) {
        // remove hidden class for every panel
        if (this.animated)
          this.$.panelSelector.getContentChildren().forEach(
            function(element) {
              element.style.display = "flex";
            });
        this.$.panelSelector.select(this.selectedLabelIndex);
        this.deselectElement();
        this.$.groupingKeysLabelSelector.select(this.selectedLabelIndex);
        // hide non selected panels after a timeout (for not repainting)
        if (this.animated)
          this.async( function() {
            this.$.panelSelector.getContentChildren().forEach(
              function(element) {
                if(!element.classList.contains("iron-selected"))
                  element.style.display = "none";
              });
          }, 1000)
      },
      // Grouping Options
      _regroup: function(key) {
        var label = Labels[this.selectedLabelIndex];
        if (!label || !key || !Groups[label][key] || PreferedGroupingKeys[label] == key)
          return;

        PreferedGroupingKeys[label] = key;
        var panel = this.queryEffectiveChildren('section.panel[label="'+label+'"]');
        var oldgroupcards = Polymer.dom(panel).getEffectiveChildNodes();

        var elements = [];
        for (var i = 0; i < oldgroupcards.length; i++) {
          elements = elements.concat([].slice.call(oldgroupcards[i].querySelectorAll('.content')));
        }

        var newgroupcards = {};
        for (var subgroup in Groups[label][key]) {
          newgroupcards[subgroup] = new GroupCard(subgroup, Groups[label][key][subgroup].svg, this.dark);
          Polymer.dom(panel).appendChild(newgroupcards[subgroup]);
          for (var i in Groups[label][key][subgroup].ids) {
            for (var j = 0; j < elements.length; j++) {
              if (elements[j].id === Groups[label][key][subgroup].ids[i])
                break;
            }
            if (j !== elements.length) {
               Polymer.dom(newgroupcards[subgroup]).node.querySelector("section#mainContent").appendChild(elements[j]);
            }
          }
        }
        for (var i=0; i < oldgroupcards.length; i++) {
           Polymer.dom(panel).removeChild(oldgroupcards[i]);
        }
        Polymer.dom.flush();
      },
      // Selecting Element
      setSelectedElement: function(e) {
        if(e && e.detail) {
          var element = e.detail;
          if (this.selectedElement.id && this.selectedElement.id === element.id &&
              this.selectedElement.label && this.selectedElement.label === element.label){
            this.deselectElement();
          }
          else {
            if (Object.keys(this.selectedElement).length !== 0) {
              var id = this.selectedElement.id;
              var label = this.selectedElement.label;
              var pos = Nodes[label][id].indexOf(this.$.selectedElementSign);
              if (pos !== -1)
                Nodes[label][id].splice(pos, 1);
              pos = Nodes[label][id].indexOf(this.$.selectedElementTable);
              if (pos !== -1)
                Nodes[label][id].splice(pos, 1);
            }
            Nodes[element.label][element.id].push(this.$.selectedElementSign);
            Nodes[element.label][element.id].push(this.$.selectedElementTable);

            this.set("selectedElement", element);
            this.$.selectedElementSign.setElement(element);
            this.$.selectedElementTable.setElement(element);

            if (element.svg && element.svg.source) {
              this.$.selectedElementSVG.removeAttribute('hidden');
              var selected = {};
              if (ExceedingSvgPaths[element.label] && ExceedingSvgPaths[element.label][element.svg.source]) {
                selected = JSON.parse(JSON.stringify(ExceedingSvgPaths[element.label][element.svg.source]));
              }

              this.$.selectedElementSVG.setSvg(
                { source: element.svg.source,
                  initial: element.svg.path || "",
                  selectable: SvgSource[element.svg.source].selectable,
                  selected: selected } );
            }
            else {
              this.$.selectedElementSVG.toggleAttribute('hidden', true);
            }

            if (!this.opened){
              this.toggleAttribute('opened', true);
              this.playAnimation('select-in');
            }
          }
        }
      },
      deselectElement: function() {
        if (this.opened) {
          this.playAnimation('select-out');
          this.closeDrawer();
          this.toggleAttribute('opened', false);
          try {
            var id = this.selectedElement.id;
            var label = this.selectedElement.label;
            var pos = Nodes[label][id].indexOf(this.$.selectedElementSign);
            if (pos !== -1)
              Nodes[label][id].splice(pos, 1);
            pos = Nodes[label][id].indexOf(this.$.selectedElementTable);
            if (pos !== -1)
              Nodes[label][id].splice(pos, 1);
          }
          catch (err) {}
          finally { this.set("selectedElement", {}); }
        }
      },
      // Exceeding Elements
      _setExceedingElement: function(e) {
        var element = e.detail;
        if (Polymer.dom(this.$.exceedingElements).querySelectorAll('#'+element.id+'[label='+element.label+']').length === 0) {
          var node = new ListElement(element, this.showDate, false, this.dark);
          Polymer.dom(this.$.exceedingElements).appendChild(node);
          Polymer.dom(node).classList.add('exceedingElement');
          Nodes[element.label][element.id].push(node);
        }
        if (element.svg && element.svg.source && element.svg.path) {
          if (!ExceedingSvgPaths[element.label])
            ExceedingSvgPaths[element.label] = {};
          if (!ExceedingSvgPaths[element.label][element.svg.source])
            ExceedingSvgPaths[element.label][element.svg.source] = {};
          ExceedingSvgPaths[element.label][element.svg.source][element.id] = element.svg.path;
        }
        if (!this.isExceeding)
          this.isExceeding = true;
      },

      _unsetExceedingElement: function(e) {
        // var element = e.detail;
        // if (element.svg && element.svg.path)
        //   this.set("exceedingSvgPaths.#" + element.label + '.#' + element.id, "");
        // this.$.selectedElementSVG.set('selected', ExceedingSvgPaths[Labels[this.selectedLabelIndex]]);
      },

      _removeSingleExceedingElementFromList: function(e) {
        if(e.detail.target) {
          var id = e.detail.target.id;
          var label = e.detail.target.label;
          var pos = Nodes[label][id].indexOf(e.detail.target);
          Nodes[label][id].splice(pos, 1);
          Polymer.dom(this.$.exceedingElements).removeChild(e.detail.target);
        }
        if (this.$.exceedingElements.children.length === 0) {
          this.set("isExceeding", false);
          this.closeExceedsPanel();
        }
      },
      _removeAllExceedingElementFromList: function() {
        var id, label, pos;
        var nodes = Polymer.dom(this.$.exceedingElements).querySelectorAll('.exceedingElement');
        for (var i = 0; i < nodes.length; i++) {
          id = nodes[i].id;
          label = nodes[i].label;
          pos = Nodes[label][id].indexOf(nodes[i].target);
          Nodes[label][id].splice(pos, 1);
          Polymer.dom(this.$.exceedingElements).removeChild(nodes[i]);
        }
        this.set("isExceeding", false);
        this.closeExceedsPanel();
      },
      toggleTheme: function(){
        var elems = document.querySelectorAll('*');
        if(this.dark) {
          for (i = 0; i < elems.length; ++i) {
            elems[i].removeAttribute("dark");
          }
          this.dark = false;
        }
        else {
          for (i = 0; i < elems.length; ++i) {
            elems[i].setAttribute("dark", true);
          }
          this.dark = true;
        }
      },
      toggleWindowStyle: function(){
        var elems = document.querySelectorAll('group-card');
        for (i = 0; i < elems.length; ++i) {
          elems[i].toggleAttribute("without-window");
        }
      },
      toggleDateView: function(){
        var elems = document.querySelectorAll('[updatable]');
        for (i = 0; i < elems.length; ++i) {
          elems[i].toggleAttribute("show-date");
        }
      },
      toggleCollapse: function(e){
        var button = e.currentTarget;
        if (!button.hasAttribute('collapse-id')) {
          return;
        }
        var id = button.getAttribute('collapse-id');
        var collapse = document.querySelector('iron-collapse.'+id);
        var iconbutton = document.querySelector('iron-icon.collapse-arrow#'+id);
        if (collapse) {
          collapse.toggle();
          if (iconbutton) {
            if (iconbutton.getAttribute('icon') === 'arrow-drop-down')
              iconbutton.toggleAttribute('icon','arrow-drop-up');
            else
              iconbutton.toggleAttribute('icon','arrow-drop-down');
          }
        }
      },
      // Toolbar Actions
      _toolbarExpand: function() {
        if (this.opened) {
          this.set('expanded', !this.expanded);
          this.toggleAttribute('expanded', this.expanded, this.$.toolbarFooter);
        }
      },
      _computeExpandIcon: function() {
        if (this.expanded)
          return 'expand-less';
        else
          return 'expand-more';
      },
      // Toolbar-SVG-Element Control
      openSvgFullscreen: function(e) {
        this.closeDrawer();
        this.$.control.style.visibility = "hidden";
        this.$.fullscreenSvg.setSvg(e.detail);
        this.$.fullscreenSvg.set('opened', true);
        this.$.svgFullscreenContainer.classList.add("fullscreen-opened");
      },
      exitSvgFullscreen: function() {
        this.$.control.style.visibility = "visible";
        this.$.fullscreenSvg.set('opened', false);
        this.$.svgFullscreenContainer.classList.remove("fullscreen-opened");
      },
      // Panel Control
      _checkExceedsPanel: function(value) {
        if(value && !(this.$.exceedsPanel.classList.contains("exceeds-panel-opened"))) {
          this.openExceedsPanel();
        }
        else if (this.$.exceedingElements.children.length === 0)
          this.closeExceedsPanel();
      },
      openExceedsPanel: function() {
        this.$.exceedsPanel.classList.add("exceeds-panel-opened");
      },
      closeExceedsPanel: function() {
        this.$.exceedsPanel.classList.remove("exceeds-panel-opened");
      },
      toggleExceedsPanel: function() {
        this.$.exceedsPanel.classList.toggle("exceeds-panel-opened");
      },
      toggleDrawer: function(){
        this.$.drawerPanel.classList.toggle("drawer-opened");
        this.$.backdrop.classList.toggle("backdrop-opened");
      },
      closeDrawer: function(){
        this.$.drawerPanel.classList.remove("drawer-opened");
        this.$.backdrop.classList.remove("backdrop-opened");
      },
      tapBackdrop: function(){
        // this.$.exceedsPanel.classList.remove("exceeds-panel-opened");
        this.$.drawerPanel.classList.remove("drawer-opened");
        this.$.backdrop.classList.remove("backdrop-opened");
      }
    });
  </script>
</dom-module>
