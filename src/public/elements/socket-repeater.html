<dom-module id="socket-repeater">

  <script>
    Polymer({
      is: 'socket-repeater',

      properties: {
          socket: {
            type: String,
            value: "/data",
            notify: true
          },
          lastData: {
            type: Array,
            value: [],
            notify: true
          },
          lastExceeds: {
            type: Array,
            value: [],
            notify: true
          },
          lastMessage: {
            type: Date,
            value: 0,
            notify: true
          },
          lastMistake: {
            type: Date,
            value: 0,
            notify: true
          },
          lastError: {
            type: Date,
            value: 0,
            notify: true
          },
          maxTotalLines: {
            type: Number,
            value: 30,
            notify: true
          },
          totalLines: {
            type: Number,
            value: 0,
            notify: true
          },
          newLines: {
            type: Number,
            value: 0,
            notify: true
          },
          doAppend: {
            type: Boolean,
            value: true,
            notify: true
          }
      },

      ready: function(){
        var self = this;
        var dataSocket = io.connect('https://'+window.location.host+this.socket, {secure: true});
        // Receiving the first Data
        dataSocket.on('first', function(message) {
          if(message === undefined) return; // Check the Existence

          self.lastMessage = new Date(message.time);
          self.lastData = message.content;
          self.lastExceeds = message.lastExceeds;
          self.newLines = message.lineCount;
          self.totalLines = message.lineCount;

        });

        // Receive another Data
        dataSocket.on('data', function(message) {
          if(message === undefined) return; // Check for Existence

          self.lastMessage = new Date(message.time);
          // $.extend(self.lastExceeds,message.lastExceeds);
          self.newLines = message.lineCount;

          if (self.doAppend){
              for (var i=0; i < self.lastData.length; i++) {
                for (var j=0; j < message.content[i].data.length; j++) {
                  if (self.lastData[i].data.length >= self.maxTotalLines)
                    self.shift("lastData."+i+".data");
                  self.push("lastData."+i+".data",message.content[i].data[j]);
                }
              }
          }
          else {
            self.totalLines = message.lineCount;
            self.lastData = message.content;
          }
        });

        //*** Wrong Data
        dataSocket.on('mistake', function(message) {
          self.lastMistake = new Date(message.time);
          self.lastError = new Date(message.error);
        });
      }

    });
  </script>

</dom-module>
